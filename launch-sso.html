<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <title>Outbound SSO Test Page</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 2em;
      }
      pre {
        background: #f4f4f4;
        padding: 1em;
        border-radius: 5px;
      }
      .section {
        margin-bottom: 2em;
      }
    </style>
  </head>
  <body>
    <h1>Outbound SSO Test Page</h1>

    <div class="section">
      <h2>1. Incoming URL Parameters</h2>
      <pre id="paramsDisplay">Loading...</pre>
    </div>

    <div class="section">
      <h2>2. Constructed Vendor URL</h2>
      <pre id="vendorUrlDisplay">Generating...</pre>
    </div>

    <div class="section">
      <h2>3. Attempting to Open Vendor URL in Native Browser...</h2>
      <p>If successful, the device's default browser should launch shortly.</p>
    </div>

    <div class="section">
      <button onclick="openInNativeBrowser()">Open in Native Browser</button>
    </div>

    <script>
      // Step 1: Parse the URL params
      const params = new URLSearchParams(window.location.search);
      const paramObject = {};
      for (const [key, value] of params.entries()) {
        paramObject[key] = value;
      }

      // Show the incoming data
      document.getElementById("paramsDisplay").textContent = JSON.stringify(
        paramObject,
        null,
        2
      );

      // Step 2: Create a mock vendor URL with token
      const mockVendorBase = "https://vendor.example.com/sso";
      const token = paramObject["token"] || "mock-token";
      const vendorUrl = `${mockVendorBase}?auth=${encodeURIComponent(token)}`;

      // Show the vendor URL
      document.getElementById("vendorUrlDisplay").textContent = vendorUrl;

      // Step 3: Try to postMessage to open in native browser
      function openInNativeBrowser() {
        // Use the constructed vendor URL instead of hardcoded URL
        const ssoUrl = vendorUrl;

        // Check if ht object exists (mobile app context)
        if (typeof ht !== "undefined" && ht.postMessage) {
          ht.postMessage({
            type: "WEBVIEW__OPEN_IN_NATIVE_BROWSER",
            url: ssoUrl,
          });
        } else {
          // Fallback for testing in regular browser
          console.log("Would open in native browser:", ssoUrl);
          window.open(ssoUrl, "_blank");
        }
      }

      // Initialize the page when the DOM is fully loaded
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Page loaded and ready");
        // Auto-trigger on page load
        autoTriggerNativeBrowser();
      });

      // Also trigger when window fully loads (including images, etc.)
      window.addEventListener("load", function () {
        console.log("Window fully loaded");
        // Small delay to ensure everything is ready
        setTimeout(autoTriggerNativeBrowser, 100);
      });

      // Auto-trigger function with mobile device detection
      function autoTriggerNativeBrowser() {
        // Check if this is a mobile device
        const isMobile =
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent
          );

        // Check if we're in a webview (common mobile app indicators)
        const isWebView =
          typeof ht !== "undefined" || // Your specific webview object
          window.navigator.userAgent.includes("wv") || // Android WebView
          (window.navigator.userAgent.includes("Version/") &&
            window.navigator.userAgent.includes("Mobile")); // iOS WebView

        console.log("Device detection:", { isMobile, isWebView });

        // Auto-trigger only on mobile devices or in webview
        if (isMobile || isWebView) {
          console.log("Auto-triggering native browser on mobile device");
          openInNativeBrowser();
        } else {
          console.log("Desktop detected - manual trigger required");
        }
      }
    </script>
  </body>
</html>
